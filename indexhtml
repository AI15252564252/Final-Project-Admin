<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="light dark" />
  <title>Dino Dig Admin</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --red:#b11e24;

      --bg-dark:#0f0f14;
      --card-dark:#171721;
      --border-dark:#2a2a3a;
      --text-dark:#f2f2f7;
      --muted-dark:#b0b0c3;

      --bg-light:#f7f4ef;
      --card-light:#ffffff;
      --border-light:#e0d7c9;
      --text-light:#222222;
      --muted-light:#666666;

      --radius:18px;
    }

    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      min-height:100vh;
      overflow-x:hidden;
    }

    body.dark{ background:var(--bg-dark); color:var(--text-dark); }
    body:not(.dark){ background:var(--bg-light); color:var(--text-light); }

    header{
      position:fixed;
      top:0; left:0; right:0;
      z-index:20;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(10,10,14,0.35); backdrop-filter: blur(10px);
      pointer-events:none;
    }
    header .btn{ pointer-events:auto; }

    .btn{
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid;
      background: transparent;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 0.01em;
      user-select:none;
    }
    body.dark .btn{ border-color: var(--border-dark); color: var(--text-dark); }
    body.dark .btn:hover{ background: rgba(255,255,255,0.06); }
    body:not(.dark) .btn{ border-color: var(--border-light); color: var(--text-light); }
    body:not(.dark) .btn:hover{ background: rgba(0,0,0,0.04); }

    .wrap{
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 88px 16px 28px;
      position:relative;
      z-index:1;
    }

    .dino{
      position:fixed;
      font-size: 54px;
      pointer-events:none;
      z-index:0;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,0.35));
    }
    body.dark .dino{ opacity: 0.18; }
    body:not(.dark) .dino{ opacity: 0.45; }

    .d1{ top: 18%; left: 4%; transform: rotate(-7deg); }
    .d2{ top: 18%; right: 4%; transform: rotate(7deg); }
    .d3{ bottom: 18%; left: 5%; transform: rotate(9deg); }
    .d4{ bottom: 18%; right: 5%; transform: rotate(-9deg); }

    @media (max-width: 820px){
      .dino{ display:none; }
      header{ position:sticky; pointer-events:auto; justify-content:space-between; }
    }

    .card{
      width: min(460px, 92vw);
      border-radius: var(--radius);
      border: 1px solid;
      overflow:hidden;
      box-shadow: 0 22px 50px rgba(0,0,0,0.22);
    }
    body.dark .card{ background: var(--card-dark); border-color: var(--border-dark); }
    body:not(.dark) .card{ background: var(--card-light); border-color: var(--border-light); box-shadow: 0 18px 44px rgba(0,0,0,0.12); }

    .card-top{
      padding: 18px 18px 14px;
      border-bottom: 1px solid;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    body.dark .card-top{ border-bottom-color: var(--border-dark); }
    body:not(.dark) .card-top{ border-bottom-color: var(--border-light); }

    .title{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: 0.01em;
    }
    .subtitle{
      font-size: 13px;
      line-height: 1.45;
    }
    body.dark .subtitle{ color: var(--muted-dark); }
    body:not(.dark) .subtitle{ color: var(--muted-light); }

    .card-body{ padding: 16px 18px 18px; }

    .field{ margin-top: 14px; }
    label{
      display:block;
      font-size: 12px;
      font-weight: 900;
      margin-bottom: 6px;
      letter-spacing: 0.02em;
    }

    input{
      width: 100%;
      border-radius: 999px;
      padding: 11px 12px;
      border: 1px solid;
      background: transparent;
      outline:none;
      font-size: 14px;
    }
    body.dark input{ border-color: var(--border-dark); background: #101014; color: var(--text-dark); }
    body:not(.dark) input{ border-color: var(--border-light); background: #fff; color: var(--text-light); }

    input:focus{
      border-color: rgba(0,95,187,0.85);
      box-shadow: 0 0 0 2px rgba(0,95,187,0.20);
    }

    .actions{
      margin-top: 16px;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .btn-primary{
      border:none !important;
      background: var(--red) !important;
      color: #fff !important;
      padding: 11px 16px;
      box-shadow: 0 14px 28px rgba(177,30,36,0.28);
      flex: 1 1 180px;
      text-align:center;
    }
    .btn-primary:hover{ filter: brightness(0.94); }

    .helper{
      font-size: 12px;
      opacity: 0.85;
      flex: 1 1 160px;
    }
    body.dark .helper{ color: var(--muted-dark); }
    body:not(.dark) .helper{ color: var(--muted-light); }

    .notice{
      display:none;
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 107, 107, 0.45);
      background: rgba(255, 107, 107, 0.12);
      color: #ffd3d3;
      font-weight: 800;
      font-size: 13px;
      letter-spacing: 0.01em;
    }
    body:not(.dark) .notice{
      border-color: rgba(139, 27, 31, 0.35);
      background: rgba(177, 30, 36, 0.10);
      color: #8b1b1f;
    }

    .footer{
      margin-top: 14px;
      font-size: 12px;
      opacity: 0.75;
      text-align:center;
    }
    body.dark .footer{ color: var(--muted-dark); }
    body:not(.dark) .footer{ color: var(--muted-light); }
  
    
    /* Header brand style (matches application header vibe) */
    .brand{
      pointer-events:none;
      display:flex;
      flex-direction:column;
      gap:2px;
      user-select:none;
      max-width: 66vw;
      overflow:hidden;
    }
    .brand-title{
      font-family: Georgia, "Times New Roman", Times, serif;
      font-weight: 800;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-size: 14px;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brand-sub{
      font-size: 12px;
      line-height: 1.05;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.85;
    }
    body.dark .brand-sub{ color: var(--muted-dark); }
    body:not(.dark) .brand-sub{ color: var(--muted-light); }


    /* Header bar */
    body.dark header{ border-bottom: 1px solid rgba(255,255,255,0.08); }
    body:not(.dark) header{ border-bottom: 1px solid rgba(0,0,0,0.06); background: rgba(255,255,255,0.55); }


    .divider{
      height: 1px;
      width: 100%;
      margin: 14px 0 6px;
      background: rgba(255,255,255,0.10);
    }
    body:not(.dark) .divider{
      background: rgba(0,0,0,0.08);
    }
    .jsonbox{
      margin-top: 6px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      color: inherit;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 120px;
      max-height: 260px;
      overflow:auto;
    }
    body:not(.dark) .jsonbox{
      border-color: rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.45);
    }

  </style>
</head>

<body class="dark">
  <header>
        <div class="brand" aria-label="Organization name">
      <div class="brand-title">SOUTHWESTERN ADVENTIST UNIVERSITY</div>
      <div class="brand-sub">Dino Dig Admin Console</div>
    </div>
<button id="themeBtn" class="btn" type="button" aria-pressed="true">‚òÄÔ∏è Light mode</button>
  </header>

  <div class="dino d1">ü¶ï</div>
  <div class="dino d2">ü¶ñ</div>
  <div class="dino d3">ü¶ñ</div>
  <div class="dino d4">ü¶ï</div>

  <main class="wrap">
    <section class="card" aria-label="Admin login">
      <div class="card-top">
        <div class="title">Admin Sign In</div>
        <div class="subtitle">Enter your credentials to access the admin dashboard.</div>
      </div>

      <div class="card-body">
        <form id="loginForm" autocomplete="on" novalidate>
          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" inputmode="email" />
          </div>

          <div class="field">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" autocomplete="current-password" />
          </div>

          <div id="loginNotice" class="notice" role="status" aria-live="polite">
            Login Rejected. Try Again
          </div>

          <div class="actions">
            <button id="signInBtn" class="btn btn-primary" type="submit">Sign in</button>
</div>

          <div class="footer">Dino Dig ‚Ä¢ Admin</div>
        </form>
      </div>
    </section>
    <section id="dashCard" class="card" aria-label="Admin dashboard" style="display:none;">
      <div class="card-top">
        <div class="title">Admin Dashboard</div>
        <div class="subtitle">Create, search, update, and delete applicants.</div>
      </div>

      <div class="card-body">
        <div class="field">
          <label for="searchKey">Search by Email or Username</label>
          <input id="searchKey" name="searchKey" type="text" autocomplete="off" inputmode="email" placeholder="email@example.com or username" />
        </div>

        <div class="actions">
          <button id="searchBtn" class="btn btn-primary" type="button">Search</button>
          <button id="clearBtn" class="btn btn-ghost" type="button">Clear</button>
          <button id="signOutBtn" class="btn btn-ghost" type="button">Sign out</button>
        </div>

        <div class="divider" aria-hidden="true"></div>

        <form id="crudForm" novalidate>
          <div class="field">
            <label for="first_name">First name</label>
            <input id="first_name" name="first_name" type="text" autocomplete="given-name" />
          </div>

          <div class="field">
            <label for="last_name">Last name</label>
            <input id="last_name" name="last_name" type="text" autocomplete="family-name" />
          </div>

          <div class="field">
            <label for="username">Username (optional)</label>
            <input id="username" name="username" type="text" autocomplete="username" />
          </div>

          <div class="field">
            <label for="email_dash">Email</label>
            <input id="email_dash" name="email_dash" type="email" autocomplete="email" inputmode="email" />
          </div>

          <div class="field">
            <label for="full_address">Full address</label>
            <input id="full_address" name="full_address" type="text" autocomplete="street-address" placeholder="Street, City, State ZIP" />
          </div>

          <div class="field">
            <label for="transportation_info">Transportation information</label>
            <input id="transportation_info" name="transportation_info" type="text" placeholder="e.g., Driving (needs pickup: no)" />
          </div>

          <div class="field">
            <label for="dietary_info">Dietary information</label>
            <input id="dietary_info" name="dietary_info" type="text" placeholder="e.g., Vegan; Allergies: peanuts" />
          </div>

          <div class="actions">
            <button id="createBtn" class="btn btn-primary" type="button">Create</button>
            <button id="updateBtn" class="btn btn-ghost" type="button">Update</button>
            <button id="deleteBtn" class="btn btn-ghost" type="button">Delete</button>
          </div>
        </form>

        <div class="field">
          <label>Full record (JSON)</label>
          <pre id="recordJson" class="jsonbox"></pre>
        </div>

        <div id="dashNotice" class="notice" role="status" aria-live="polite"></div>

        <div class="footer">Dino Dig ‚Ä¢ Admin</div>
      </div>
    </section>

  </main>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// Supabase (replace with your project values)
const SUPABASE_URL = "https://bxmrdhjczirudojvxtnh.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_58rJq5mJZRcCZi6xXL8t0w_c_wkRhcd";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Theme
const themeBtn = document.getElementById("themeBtn");
const savedTheme = localStorage.getItem("dd_admin_theme");
if (savedTheme === "light") document.body.classList.remove("dark");
if (savedTheme === "dark") document.body.classList.add("dark");

function syncThemeUI(){
  const isDark = document.body.classList.contains("dark");
  themeBtn.textContent = isDark ? "‚òÄÔ∏è Light mode" : "üåô Dark mode";
  themeBtn.setAttribute("aria-pressed", String(isDark));
  localStorage.setItem("dd_admin_theme", isDark ? "dark" : "light");
}
syncThemeUI();

themeBtn.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  syncThemeUI();
});

// Login / Dashboard UI
const loginCard = document.querySelector('section[aria-label="Admin login"]');
const dashCard = document.getElementById("dashCard");

const loginForm = document.getElementById("loginForm");
const loginNotice = document.getElementById("loginNotice");
const emailEl = document.getElementById("email");
const pwEl = document.getElementById("password");

const dashNotice = document.getElementById("dashNotice");
const recordJson = document.getElementById("recordJson");
const searchKeyEl = document.getElementById("searchKey");
const searchBtn = document.getElementById("searchBtn");
const clearBtn = document.getElementById("clearBtn");
const signOutBtn = document.getElementById("signOutBtn");

const crudForm = document.getElementById("crudForm");
const firstNameEl = document.getElementById("first_name");
const lastNameEl = document.getElementById("last_name");
const usernameEl = document.getElementById("username");
const emailDashEl = document.getElementById("email_dash");
const fullAddressEl = document.getElementById("full_address");
const transportationEl = document.getElementById("transportation_info");
const dietaryEl = document.getElementById("dietary_info");

const createBtn = document.getElementById("createBtn");
const updateBtn = document.getElementById("updateBtn");
const deleteBtn = document.getElementById("deleteBtn");

let currentApplicant = null;

function showLogin(){
  if (loginCard) loginCard.style.display = "";
  if (dashCard) dashCard.style.display = "none";
}

function showDashboard(){
  if (loginCard) loginCard.style.display = "none";
  if (dashCard) dashCard.style.display = "";
}

function setNotice(el, msg){
  if (!el) return;
  if (!msg){
    el.style.display = "none";
    el.textContent = "";
    return;
  }
  el.textContent = msg;
  el.style.display = "block";
}

function sanitizeKey(v){
  return String(v || "").trim().replace(/,/g, "");
}

function fillFormFromApplicant(row){
  currentApplicant = row || null;
  firstNameEl.value = row?.first_name || "";
  lastNameEl.value = row?.last_name || "";
  usernameEl.value = row?.username || "";
  emailDashEl.value = row?.email || "";
  fullAddressEl.value = row?.full_address || "";
  transportationEl.value = row?.transportation_info || "";
  dietaryEl.value = row?.dietary_info || "";
  recordJson.textContent = row ? JSON.stringify(row, null, 2) : "";
}

function readForm(){
  const first_name = (firstNameEl.value || "").trim();
  const last_name = (lastNameEl.value || "").trim();
  const username = (usernameEl.value || "").trim() || null;
  const email = (emailDashEl.value || "").trim().toLowerCase();
  const full_address = (fullAddressEl.value || "").trim();
  const transportation_info = (transportationEl.value || "").trim();
  const dietary_info = (dietaryEl.value || "").trim();

  return { first_name, last_name, username, email, full_address, transportation_info, dietary_info };
}

function validateRequired(rec){
  if (!rec.first_name || !rec.last_name || !rec.email || !rec.full_address){
    setNotice(dashNotice, "Missing required fields: first name, last name, email, full address.");
    return false;
  }
  return true;
}

async function findApplicantByKey(key){
  const q = sanitizeKey(key);
  if (!q) return { row:null, error: new Error("Enter an email or username.") };

  const { data, error } = await supabase
    .from("applicants")
    .select("*")
    .or(`email.eq.${q},username.eq.${q}`)
    .limit(1);

  if (error) return { row:null, error };
  const row = (data && data.length) ? data[0] : null;
  return { row, error: row ? null : new Error("No applicant found for that email/username.") };
}

async function refreshSession(){
  const { data: { session }, error } = await supabase.auth.getSession();
  if (error) console.warn(error);
  if (session) showDashboard();
  else showLogin();
}

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  setNotice(loginNotice, "");
  const email = (emailEl.value || "").trim();
  const password = (pwEl.value || "").trim();
  if (!email || !password){
    setNotice(loginNotice, "Please enter your email and password.");
    return;
  }

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error){
    setNotice(loginNotice, error.message || "Sign-in failed.");
    return;
  }
  await refreshSession();
});

signOutBtn.addEventListener("click", async () => {
  await supabase.auth.signOut();
  fillFormFromApplicant(null);
  setNotice(dashNotice, "");
  await refreshSession();
});

searchBtn.addEventListener("click", async () => {
  setNotice(dashNotice, "");
  const key = searchKeyEl.value;
  const { row, error } = await findApplicantByKey(key);
  if (error){
    fillFormFromApplicant(null);
    setNotice(dashNotice, error.message || "Search failed.");
    return;
  }
  fillFormFromApplicant(row);
  setNotice(dashNotice, "Applicant loaded.");
});

clearBtn.addEventListener("click", () => {
  searchKeyEl.value = "";
  fillFormFromApplicant(null);
  setNotice(dashNotice, "");
});

createBtn.addEventListener("click", async () => {
  setNotice(dashNotice, "");
  const rec = readForm();
  if (!validateRequired(rec)) return;

  const payload = {
    ...rec,
    raw_payload: { source: "admin", ...rec },
  };

  const { data, error } = await supabase.from("applicants").insert([payload]).select("*").limit(1);
  if (error){
    setNotice(dashNotice, error.message || "Create failed.");
    return;
  }
  const row = data?.[0] || null;
  fillFormFromApplicant(row);
  setNotice(dashNotice, "Applicant created.");
});

updateBtn.addEventListener("click", async () => {
  setNotice(dashNotice, "");
  const rec = readForm();
  if (!validateRequired(rec)) return;

  // Use email/username as the lookup key (rubric) then update by id (safer)
  const key = sanitizeKey(searchKeyEl.value || rec.email || rec.username);
  const { row, error: findErr } = currentApplicant
    ? { row: currentApplicant, error: null }
    : await findApplicantByKey(key);

  if (findErr){
    setNotice(dashNotice, findErr.message || "Update failed (no matching applicant).");
    return;
  }

  const updates = {
    ...rec,
    raw_payload: { ...(row.raw_payload || {}), source: "admin_update", ...rec },
  };

  const { data, error } = await supabase
    .from("applicants")
    .update(updates)
    .eq("id", row.id)
    .select("*")
    .limit(1);

  if (error){
    setNotice(dashNotice, error.message || "Update failed.");
    return;
  }

  const updated = data?.[0] || null;
  fillFormFromApplicant(updated);
  setNotice(dashNotice, "Applicant updated.");
});

deleteBtn.addEventListener("click", async () => {
  setNotice(dashNotice, "");
  const key = sanitizeKey(searchKeyEl.value || emailDashEl.value || usernameEl.value);
  const { row, error: findErr } = currentApplicant
    ? { row: currentApplicant, error: null }
    : await findApplicantByKey(key);

  if (findErr){
    setNotice(dashNotice, findErr.message || "Delete failed (no matching applicant).");
    return;
  }

  const ok = confirm(`Delete applicant: ${row.email || row.username || row.id}?`);
  if (!ok) return;

  const { error } = await supabase.from("applicants").delete().eq("id", row.id);
  if (error){
    setNotice(dashNotice, error.message || "Delete failed.");
    return;
  }

  fillFormFromApplicant(null);
  setNotice(dashNotice, "Applicant deleted.");
});

// Initialize UI based on session
await refreshSession();
  </script>
</body>
</html>
